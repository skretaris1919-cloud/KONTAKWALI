<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Pantau Wali Santri</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f0f0f0;
    }

.container {
  max-width: 400px;
  margin: 0 auto;         /* hilangkan margin atas */
  padding: 0 15px 15px;   /* padding atas = 0 */
  background-color: #e0f0ff;
  border-radius: 10px;
  box-shadow: 0 0 5px rgba(0,0,0,0.1);
}
    h2 {
      text-align: center;
      color: #004080;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .form-group {
      margin-bottom: 12px;
    }

    label {
      display: block;
      font-weight: bold;
      margin-bottom: 4px;
      font-size: 13px;
    }

    input[type="text"] {
      width: 100%;
      padding: 8px;
      font-size: 13px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }

    #noid {
      background-color: #ffe5b4;
    }

    .btn {
      margin-top: 15px;
      background-color: #28a745;
      color: white;
      border: none;
      padding: 10px;
      font-weight: bold;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
      font-size: 14px;
    }

    .btn:hover {
      background-color: #218838;
    }

    .note {
      font-size: 12px;
      color: #ff6600;
      margin-top: 5px;
    }

    .error {
      color: red;
      font-size: 13px;
      margin-top: 5px;
    }

    .form-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .form-row .form-group {
      flex: 1 1 48%;
    }

    @media (max-width: 480px) {
      .container {
        width: 90%;
      }
    }
  </style>
</head>
<body>
<body style="margin:0; padding:0;">
  <div class="container">
   <h2 style="margin-top:0;">Data Santri Idadiyah-Takhossus</h2>
    <p style="text-align:center; font-size:12px; color:#555; margin-top:-10px; margin-bottom:15px;">
  PP Al Falah As Salafi Al Kholili Kepang
</p>

 <div class="form-group" style="text-align:center; display:flex; flex-direction:column; align-items:center;">
  <label for="noid" style="margin-bottom:6px;">No ID Santri</label>
  <input type="text"
         id="noid"
         placeholder="Masukkan No ID"
         oninput="ambilDataSantri(this.value)"
         style="width:220px; text-align:center; padding:6px 12px; border-radius:6px; border:1px solid #ccc;">
</div>

<div class="form-group" style="text-align:center;">
  <label for="foto-santri">Foto Santri</label>

  <!-- Kotak branding tampil sejak awal -->
  <div id="foto-box"
       style="display:flex; justify-content:center; align-items:center; height:130px;
              background-image: url('https://brnqpdvtninzyqqwhmfj.supabase.co/storage/v1/object/public/fotoku12/tausiah.jpg');
              background-size: cover;
              background-position: center top;
              border-radius: 8px;
              box-shadow: 0 0 4px rgba(0,0,0,0.1);
              position: relative;">
    
    <!-- Gambar santri, disembunyikan dulu -->
    <img id="foto-santri"
         src=""
         alt="Foto Santri"
         style="display:none; max-width:160px; max-height:120px; object-fit:cover; border-radius:8px; box-shadow:0 0 4px rgba(0,0,0,0.2);">

    <!-- Ikon üì∑ tampil sebelum gambar santri dimuat -->
    <div id="foto-icon" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:28px; color:#aaa;">
      üì∑
    </div>
  </div>
</div>

    <div class="form-group">
      <label for="nama">Nama Santri</label>
      <input type="text" id="nama" readonly>
    </div>

    <div class="form-group">
      <label for="alamat">Alamat</label>
      <input type="text" id="alamat" readonly>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="kamar">Kamar</label>
        <input type="text" id="kamar" readonly>
      </div>
      <div class="form-group">
        <label for="saldo-kiriman">Saldo Kiriman</label>
        <input type="text" id="saldo-kiriman" readonly>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="saldo-tabungan">Saldo Tabungan</label>
        <input type="text" id="saldo-tabungan" readonly>
      </div>
      <div class="form-group">
        <label for="pengeluaran-hari">Pengeluaran Hari Ini</label>
        <input type="text" id="pengeluaran-hari" readonly>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="pengeluaran-pekan">Pengeluaran 1 Pekan</label>
        <input type="text" id="pengeluaran-pekan" readonly>
      </div>
      <div class="form-group">
        <label for="pengeluaran-bulan">Pengeluaran 1 Bulan</label>
        <input type="text" id="pengeluaran-bulan" readonly>
      </div>
    </div>

    <div class="form-group">
      <label for="nowa">No WA Wali Santri</label>
      <input type="text" id="nowa" placeholder="Contoh: 6281234567890">
      <div class="note">Nomor WA harus dimulai dengan <strong>628xxxx</strong></div>
      <div id="wa-error" class="error"></div>
    </div>

    <button class="btn" onclick="validasiWA()">Simpan</button>
  </div>

<script>
  const supabaseHeaders = {
    apikey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJybnFwZHZ0bmluenlxcXdobWZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NjU3OTQsImV4cCI6MjA3MzE0MTc5NH0.6u2P5ANnDV1237hEY73M0OHRDftwc3-G0JbRx44YcZc",
    Authorization: "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJybnFwZHZ0bmluenlxcXdobWZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NjU3OTQsImV4cCI6MjA3MzE0MTc5NH0.6u2P5ANnDV1237hEY73M0OHRDftwc3-G0JbRx44YcZc",
    "Content-Type": "application/json"
  };

  function ambilDataSantri(noid) {
    if (!noid || noid.length < 3) return;

    const url = `https://brnqpdvtninzyqqwhmfj.supabase.co/rest/v1/tb_saldo?select=nama,alamat,nama_kamar,saldo_tabungan,jumlah_kiriman,foto_url&no_id=eq.${noid}&limit=1`;

    fetch(url, { headers: supabaseHeaders })
      .then(res => {
        if (!res.ok) throw new Error("Gagal ambil data (status " + res.status + ")");
        return res.json();
      })
      .then(data => {
        const imgEl = document.getElementById("foto-santri");
        const icon = document.getElementById("foto-icon");
        const box = document.getElementById("foto-box");

        if (!data || data.length === 0) {
          document.getElementById("nama").value = "‚ùå Tidak ditemukan";
          document.getElementById("alamat").value = "";
          document.getElementById("kamar").value = "";
          document.getElementById("saldo-kiriman").value = "";
          document.getElementById("saldo-tabungan").value = "";
          hapusPengeluaran();

          if (imgEl) imgEl.style.display = "none";
          if (icon) icon.style.display = "block";
          if (box) box.style.backgroundImage = `url('https://brnqpdvtninzyqqwhmfj.supabase.co/storage/v1/object/public/fotoku12/tausiah.jpg')`;
          return;
        }

        const santri = data[0];
        document.getElementById("nama").value = santri.nama || "";
        document.getElementById("alamat").value = santri.alamat || "";
        document.getElementById("kamar").value = santri.nama_kamar || "";
        document.getElementById("saldo-kiriman").value = formatRupiah(santri.jumlah_kiriman || 0);
        document.getElementById("saldo-tabungan").value = formatRupiah(santri.saldo_tabungan || 0);

        if (santri.foto_url && imgEl && icon && box) {
          imgEl.src = santri.foto_url;
          imgEl.style.display = "block";
          icon.style.display = "none";
          box.style.backgroundImage = `url('https://brnqpdvtninzyqqwhmfj.supabase.co/storage/v1/object/public/fotoku12/tausiah.jpg')`;
        } else {
          imgEl.style.display = "none";
          icon.style.display = "block";
          box.style.backgroundImage = `url('https://brnqpdvtninzyqqwhmfj.supabase.co/storage/v1/object/public/fotoku12/tausiah.jpg')`;
        }

        ambilPengeluaran(noid);
      })
      .catch(err => {
        console.error("‚ùå Gagal ambil data:", err);
        document.getElementById("nama").value = "‚ùå Error";
        document.getElementById("alamat").value = "";
        document.getElementById("kamar").value = "";
        document.getElementById("saldo-kiriman").value = "";
        document.getElementById("saldo-tabungan").value = "";
        hapusPengeluaran();

        const imgEl = document.getElementById("foto-santri");
        const icon = document.getElementById("foto-icon");
        const box = document.getElementById("foto-box");

        if (imgEl) imgEl.style.display = "none";
        if (icon) icon.style.display = "block";
        if (box) box.style.backgroundImage = `url('https://brnqpdvtninzyqqwhmfj.supabase.co/storage/v1/object/public/fotoku12/tausiah.jpg')`;
      });
  }

  function hapusPengeluaran() {
    document.getElementById("pengeluaran-hari").value = "";
    document.getElementById("pengeluaran-pekan").value = "";
    document.getElementById("pengeluaran-bulan").value = "";
  }

  function ambilPengeluaran(noid) {
    const now = new Date();
    const hariIni = now.toISOString().slice(0, 10);
    const pekanLalu = new Date(now.getTime() - 7 * 86400000).toISOString();
    const bulanLalu = new Date(now.getTime() - 30 * 86400000).toISOString();

    const baseURL = "https://brnqpdvtninzyqqwhmfj.supabase.co/rest/v1/tb_transaksi";

    const queryHari = `${baseURL}?select=nominal&waktu=gte.${hariIni}&no_id=eq.${noid}`;
    const queryPekan = `${baseURL}?select=nominal&waktu=gte.${pekanLalu}&no_id=eq.${noid}`;
    const queryBulan = `${baseURL}?select=nominal&waktu=gte.${bulanLalu}&no_id=eq.${noid}`;

    Promise.all([
      fetch(queryHari, { headers: supabaseHeaders }).then(res => res.json()),
      fetch(queryPekan, { headers: supabaseHeaders }).then(res => res.json()),
      fetch(queryBulan, { headers: supabaseHeaders }).then(res => res.json())
    ])
    .then(([hari, pekan, bulan]) => {
      const filterNominal = arr => arr
        .map(t => parseInt(t.nominal || 0))
        .filter(n => n > 0 && n < 10000000);

      const totalHari = filterNominal(hari).reduce((sum, n) => sum + n, 0);
      const totalPekan = filterNominal(pekan).reduce((sum, n) => sum + n, 0);
      const totalBulan = filterNominal(bulan).reduce((sum, n) => sum + n, 0);

      document.getElementById("pengeluaran-hari").value = formatRupiah(totalHari);
      document.getElementById("pengeluaran-pekan").value = formatRupiah(totalPekan);
      document.getElementById("pengeluaran-bulan").value = formatRupiah(totalBulan);
    })
    .catch(err => {
      console.error("‚ùå Gagal ambil pengeluaran:", err);
      document.getElementById("pengeluaran-hari").value = "Rp 0";
      document.getElementById("pengeluaran-pekan").value = "Rp 0";
      document.getElementById("pengeluaran-bulan").value = "Rp 0";
    });
  }

  function validasiWA() {
    const nowa = document.getElementById("nowa").value.trim();
    const noid = document.getElementById("noid").value.trim();
    const errorDiv = document.getElementById("wa-error");

    if (!nowa.startsWith("628")) {
      errorDiv.textContent = "‚ùå Nomor WA harus dimulai dengan 628.";
      return;
    } else if (nowa.length < 10 || nowa.length > 15) {
      errorDiv.textContent = "‚ùå Panjang nomor WA tidak valid.";
      return;
    }

    if (!noid || noid.length < 3) {
      errorDiv.textContent = "‚ùå No ID Santri tidak boleh kosong.";
      return;
    }

    errorDiv.textContent = "";

    const url = `https://brnqpdvtninzyqqwhmfj.supabase.co/rest/v1/tb_saldo?no_id=eq.${noid}`;
    const body = JSON.stringify({ wa: nowa });

    fetch(url, {
      method: "PATCH",
      headers: supabaseHeaders,
      body: body
    })
    .then(async res => {
      if (!res.ok) throw new Error("Gagal update WA (status " + res.status + ")");
      const text = await res.text();
      if (!text) return {};
      return JSON.parse(text);
    })
    .then(() => {
      alert("‚úÖ Nomor WA berhasil disimpan.");
      kosongkanForm();
    })
    .catch(err => {
      console.error("‚ùå Gagal simpan WA:", err);
      errorDiv.textContent = "‚ùå Gagal menyimpan ke server.";
    });
  }

  function kosongkanForm() {
    const ids = [
      "noid", "nama", "alamat", "kamar", "saldo-kiriman", "saldo-tabungan",
      "pengeluaran-hari", "pengeluaran-pekan", "pengeluaran-bulan", "nowa"
    ];
    ids.forEach(id => document.getElementById(id).value = "");
        document.getElementById("wa-error").textContent = "";

    const imgEl = document.getElementById("foto-santri");
    const icon = document.getElementById("foto-icon");
    const box = document.getElementById("foto-box");

    if (imgEl) imgEl.style.display = "none";
    if (icon) icon.style.display = "block";
    if (box) box.style.backgroundImage = `url('https://brnqpdvtninzyqqwhmfj.supabase.co/storage/v1/object/public/fotoku12/tausiah.jpg')`;
  }

  function formatRupiah(nilai) {
    if (typeof nilai !== "number") nilai = parseInt(nilai) || 0;
    return "Rp " + nilai.toLocaleString("id-ID");
  }

</script>
</body>
</html>
   
